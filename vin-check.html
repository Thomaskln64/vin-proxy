<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FZB-24 VIN PrÃ¼fung</title>
  <style>
    :root{
      --brand:#9F1239; /* ruhiges rot */
      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.12);
      --soft:#f8fafc;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
    .logo{font-weight:950;font-size:18px}
    .logo span{color:var(--brand)}
    .card{border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr;} }

    .hero{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 14px 14px 18px;
      position:relative;
      background:linear-gradient(180deg,#0b1220,#0f1a33);
      color:#fff;
      margin-bottom:14px;
      overflow:hidden;
    }
    .hero:before{content:"";position:absolute;left:0;top:0;bottom:0;width:10px;background:var(--brand)}
    .h1{margin:0 0 4px 0;font-weight:950;font-size:20px}
    .sub{color:#e2e8f0;font-size:12px;opacity:.95}

    .secH{font-size:13px;font-weight:950;margin:0 0 10px 0;padding-left:10px;border-left:4px solid var(--brand)}
    .row{display:flex;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(15,23,42,.02);margin-bottom:10px}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:800;font-size:13px}

    .inputRow{display:flex;gap:10px;flex-wrap:wrap}
    input{
      flex:1;min-width:240px;
      padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      font-size:14px;
    }
    button{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(159,18,57,.28);
      background:linear-gradient(180deg,#fff,#fff);
      font-weight:900;cursor:pointer;
    }
    button.primary{
      background:linear-gradient(180deg,var(--brand),#b91c1c);
      color:#fff;border:0;
    }
    button:disabled{opacity:.6;cursor:not-allowed}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    .locked{
      display:flex;justify-content:space-between;gap:12px;
      border:1px dashed rgba(15,23,42,.22);
      border-radius:14px;padding:10px 12px;background:var(--soft);
      margin-bottom:10px;
    }
    .lockTitle{font-weight:900;font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid var(--line);background:#fff}
    .pill b{color:var(--brand)}
    .divider{height:1px;background:rgba(15,23,42,.08);margin:12px 0}
    .msg{padding:10px 12px;border-radius:12px;background:rgba(15,23,42,.04);border:1px solid var(--line);font-size:13px}
    .ok{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.06)}
    .err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.06)}
    a{color:var(--brand);font-weight:900;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">FZB<span>-24</span></div>
      <div class="pill">Einmalig <b>27,99 â‚¬</b> Â· kein Abo</div>
    </div>

    <div class="hero">
      <h1 class="h1">FIN PrÃ¼fung</h1>
      <div class="sub">Gib die VIN ein und sieh sofort die Basisdaten. Den vollstÃ¤ndigen Bericht bekommst du nach dem Kauf als PDF.</div>
    </div>

    <div class="card" style="margin-bottom:14px">
      <div class="inputRow">
        <input id="vinInput" placeholder="VIN eingeben (z.B. WBA3T310805B65107)" autocomplete="off" />
        <button id="btnCheck" class="primary">PrÃ¼fen</button>
      </div>
      <div class="note" style="margin-top:10px">
        Hinweis: Vorschau zeigt nur Basisdaten. Premium enthÃ¤lt zusÃ¤tzliche PrÃ¼fungen und Details.
      </div>
    </div>

    <div id="statusBox" class="msg" style="display:none;margin-bottom:14px"></div>

    <div id="resultArea" style="display:none">
      <div class="grid">
        <!-- LEFT: Found vehicle -->
        <div class="card">
          <div class="secH">Fahrzeug gefunden</div>
          <div class="row"><div class="k">Marke</div><div class="v" id="make">â€”</div></div>
          <div class="row"><div class="k">Modell</div><div class="v" id="model">â€”</div></div>
          <div class="row"><div class="k">Baujahr</div><div class="v" id="year">â€”</div></div>
          <div class="row"><div class="k">Kraftstoff</div><div class="v" id="fuel">â€”</div></div>
          <div class="row"><div class="k">Getriebe</div><div class="v" id="transmission">â€”</div></div>
          <div class="row"><div class="k">Karosserie</div><div class="v" id="body">â€”</div></div>
          <div class="note" style="margin-top:10px">
            VIN: <span id="vinOut" style="font-weight:900"></span>
          </div>
        </div>

        <!-- RIGHT: Premium upsell -->
        <div class="card">
          <div class="secH">VollstÃ¤ndiger Bericht</div>

          <div id="lockedList"></div>

          <div class="divider"></div>

          <div class="note">
            Du bekommst den Bericht als PDF zum Download. Zustellung per E-Mail bauen wir als nÃ¤chstes ein.
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
            <input id="emailInput" placeholder="E-Mail fÃ¼r Zustellung (Test)" />
            <button id="btnBuy" class="primary">Bericht kaufen</button>
          </div>

          <div id="buyResult" class="msg" style="display:none;margin-top:12px"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // âœ… HIER einstellen
  const API_BASE = "http://127.0.0.1:3001";

  const vinInput = document.getElementById('vinInput');
  const btnCheck = document.getElementById('btnCheck');
  const statusBox = document.getElementById('statusBox');

  const resultArea = document.getElementById('resultArea');
  const lockedList = document.getElementById('lockedList');

  const makeEl = document.getElementById('make');
  const modelEl = document.getElementById('model');
  const yearEl = document.getElementById('year');
  const fuelEl = document.getElementById('fuel');
  const transmissionEl = document.getElementById('transmission');
  const bodyEl = document.getElementById('body');
  const vinOut = document.getElementById('vinOut');

  const emailInput = document.getElementById('emailInput');
  const btnBuy = document.getElementById('btnBuy');
  const buyResult = document.getElementById('buyResult');

  function showStatus(text, type="") {
    statusBox.style.display = 'block';
    statusBox.className = 'msg ' + type;
    statusBox.textContent = text;
  }
  function hideStatus() { statusBox.style.display = 'none'; }

  function renderLockedSections(sections) {
    lockedList.innerHTML = '';
    sections.forEach(s => {
      const div = document.createElement('div');
      div.className = 'locked';
      div.innerHTML = `
        <div>
          <div class="lockTitle">ðŸ”’ ${escapeHtml(s.title)}</div>
          <div class="note">${escapeHtml(s.hint)}</div>
        </div>
        <div class="pill"><b>Premium</b></div>
      `;
      lockedList.appendChild(div);
    });
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  async function checkVin() {
    const vin = vinInput.value.trim().toUpperCase();
    if (!vin || vin.length < 8) {
      showStatus("Bitte eine gÃ¼ltige VIN eingeben.", "err");
      return;
    }

    hideStatus();
    resultArea.style.display = 'none';
    buyResult.style.display = 'none';

    btnCheck.disabled = true;
    btnCheck.textContent = 'Sucheâ€¦';
    showStatus("Fahrzeug wird gesuchtâ€¦", "");

    try {
      const r = await fetch(`${API_BASE}/api/report/${encodeURIComponent(vin)}`);
      const data = await r.json();

      if (!data.success) {
        showStatus("Fehler bei der Abfrage. Bitte spÃ¤ter erneut versuchen.", "err");
        return;
      }

      const v = data.preview?.vehicle || {};
      makeEl.textContent = v.make || 'â€”';
      modelEl.textContent = v.model || 'â€”';
      yearEl.textContent = v.year || 'â€”';
      fuelEl.textContent = v.fuel || 'â€”';
      transmissionEl.textContent = v.transmission || 'â€”';
      bodyEl.textContent = v.body || 'â€”';
      vinOut.textContent = data.preview?.vin || vin;

      renderLockedSections(data.locked_sections || []);
      showStatus("Fahrzeug gefunden. Vorschau ist bereit.", "ok");
      resultArea.style.display = 'block';
    } catch (e) {
      showStatus("Netzwerkfehler. LÃ¤uft dein API-Server?", "err");
    } finally {
      btnCheck.disabled = false;
      btnCheck.textContent = 'PrÃ¼fen';
    }
  }

  async function buyReport() {
    const vin = vinOut.textContent.trim();
    const email = emailInput.value.trim();

    if (!vin) {
      buyResult.style.display = 'block';
      buyResult.className = 'msg err';
      buyResult.textContent = 'Bitte erst eine VIN prÃ¼fen.';
      return;
    }
    if (!email || !email.includes('@')) {
      buyResult.style.display = 'block';
      buyResult.className = 'msg err';
      buyResult.textContent = 'Bitte eine gÃ¼ltige E-Mail eingeben (Test).';
      return;
    }

    btnBuy.disabled = true;
    btnBuy.textContent = 'Erstelleâ€¦';
    buyResult.style.display = 'none';

    try {
      const r = await fetch(`${API_BASE}/api/order`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ vin, email })
      });
      const data = await r.json();

      if (!data.success) {
        buyResult.style.display = 'block';
        buyResult.className = 'msg err';
        buyResult.textContent = 'Fehler beim Erstellen des Berichts.';
        return;
      }

      buyResult.style.display = 'block';
      buyResult.className = 'msg ok';
      buyResult.innerHTML = `Danke! Dein Bericht wurde erstellt. <a href="${data.download_url}" target="_blank" rel="noopener">PDF herunterladen</a>`;
    } catch (e) {
      buyResult.style.display = 'block';
      buyResult.className = 'msg err';
      buyResult.textContent = 'Netzwerkfehler beim Kauf/Erstellen.';
    } finally {
      btnBuy.disabled = false;
      btnBuy.textContent = 'Bericht kaufen';
    }
  }

  btnCheck.addEventListener('click', checkVin);
  vinInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkVin(); });
  btnBuy.addEventListener('click', buyReport);
</script>
</body>
</html>
